name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run standardrb
        run: bundle exec standardrb

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Run tests
        run: bundle exec rake test

  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache kompo-vfs build
        uses: actions/cache@v4
        with:
          path: ../kompo-vfs/target
          key: kompo-vfs-${{ runner.os }}-v6-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            kompo-vfs-${{ runner.os }}-v6-

      - name: Clone kompo-vfs
        run: |
          if [ ! -d ../kompo-vfs ]; then
            git clone https://github.com/ahogappa/kompo-vfs.git ../kompo-vfs
          fi
          cd ../kompo-vfs
          git fetch origin
          git checkout 1a901270f8a979d05c8dccd85eabd91fe25f195e

      - name: Build kompo-vfs
        run: |
          cd ../kompo-vfs
          cargo build --release

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev libreadline-dev zlib1g-dev libyaml-dev libffi-dev

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install openssl readline libyaml libffi sqlite3
          # sqlite3 is keg-only, so we need to configure paths for both pkg-config and compiler
          # System SQLite doesn't have load_extension support, so we must use Homebrew's
          SQLITE_PREFIX=$(brew --prefix sqlite3)
          echo "PKG_CONFIG_PATH=${SQLITE_PREFIX}/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "LDFLAGS=-L${SQLITE_PREFIX}/lib $LDFLAGS" >> $GITHUB_ENV
          echo "CPPFLAGS=-I${SQLITE_PREFIX}/include $CPPFLAGS" >> $GITHUB_ENV
          # C_INCLUDE_PATH ensures homebrew headers are found before system headers
          echo "C_INCLUDE_PATH=${SQLITE_PREFIX}/include" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${SQLITE_PREFIX}/lib" >> $GITHUB_ENV

      - name: Cache kompo Ruby build
        uses: actions/cache@v4
        with:
          path: ~/.kompo/cache
          # Don't use restore-keys to avoid restoring incompatible caches with different work_dir paths
          # The cache includes work_dir path which is temp directory specific to each CI run
          key: kompo-ruby-${{ runner.os }}-3.4-v9-${{ hashFiles('lib/kompo.rb') }}

      - name: Install native_gems dependencies
        run: |
          cd samples/native_gems
          bundle install

      - name: Pack native_gems sample
        timeout-minutes: 30
        run: |
          cd samples/native_gems
          BUNDLE_GEMFILE=../../Gemfile TASKI_PROGRESS_MODE=plain bundle exec ../../exe/kompo --local-vfs-path=../../../kompo-vfs -o .

      - name: Run native_gems binary
        run: |
          cd samples/native_gems
          OUTPUT=$(./native_gems)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -q "SUCCESS: nokogiri, sqlite3 and msgpack are working correctly!"
