#!/usr/bin/env ruby
# frozen_string_literal: true

require "optparse"
require_relative "../lib/kompo"

args = {}
opt = OptionParser.new do |o|
  o.banner = "Usage: kompo [options] [files...]"
  o.separator ""
  o.separator "Options:"

  o.on("-e", "--entrypoint=FILE", "Entry point file (default: main.rb)") { |v| args[:entrypoint] = v }
  o.on("-o", "--output=DIR", "Output directory for the binary") { |v| args[:output_dir] = File.expand_path(v) }
  o.on("--ruby-version=VERSION", "Ruby version to use (default: #{RUBY_VERSION})") { |v| args[:ruby_version] = v }
  o.on("--ruby-source=PATH", "Path to Ruby source tarball or directory") do |v|
    args[:ruby_source_path] = File.expand_path(v)
  end
  o.on("--no-cache", "Build Ruby from source, ignoring cache") { |_v| args[:no_cache] = true }
  o.on("--no-stdlib", "Exclude Ruby standard library from binary") { |_v| args[:no_stdlib] = true }
  o.on("--no-gemfile", "Skip Gemfile processing (no bundle install)") { |_v| args[:no_gemfile] = true }
  o.on("--local-vfs-path=PATH", "Path to local kompo-vfs for development") do |v|
    args[:local_kompo_vfs_path] = File.expand_path(v)
  end
  o.on("--clean[=VERSION]", 'Clean cache (current Ruby version by default, or specify VERSION, or "all")') do |v|
    args[:clean_cache] = v.nil? ? RUBY_VERSION : v
  end
  o.on("--dry-run", "Show final compile command without executing it") { |_v| args[:dry_run] = true }
  o.on("--no-clean", "Skip cleanup phase (keep work directory for debugging)") { |_v| args[:no_clean] = true }
  o.on("--verbose", "Show detailed command execution output") { |_v| args[:verbose] = true }
  o.on("--dynamic-libs=LIBS", "Comma-separated list of libraries to link dynamically (e.g., ssl,crypto,gmp)") do |v|
    args[:dynamic_libs] = v.split(",").map(&:strip)
  end
  o.on("--compress", "Enable zlib compression for embedded files (reduces binary size)") do |_v|
    args[:compress] = true
  end
  o.on("--progress=MODE", "Progress display mode: simple (default, TTY only), log (plain text), tree, none") do |v|
    args[:progress] = v
  end
  o.on("--cache-dir=PATH", "Cache directory (default: ~/.kompo/cache)") do |v|
    args[:cache_dir] = File.expand_path(v)
  end
  o.on("--init", "Generate default .kompoignore file") do
    args[:init] = true
  end
  o.on("-t", "--tree", "Show task dependency tree and exit") do
    puts Kompo::Packing.tree
    exit(0)
  end
  o.on("-v", "--version", "Show version") do
    puts "kompo #{Kompo::VERSION}"
    exit(0)
  end
  o.on("-h", "--help", "Show this help message") do
    puts o
    exit(0)
  end

  o.separator ""
  o.separator "Files:"
  o.separator "  Additional files and directories to include in the binary"
end
opt.parse!(ARGV)
args[:files] = ARGV

Kompo.configure_progress(args.delete(:progress))
Kompo::CommandRunner.verbose = args[:verbose]
Kompo::CommandRunner.dry_run = args[:dry_run]

if args[:init]
  project_dir = Dir.pwd
  if Kompo::KompoIgnore.generate_default(project_dir)
    puts "Generated .kompoignore in #{project_dir}"
  else
    puts ".kompoignore already exists in #{project_dir}, skipping"
  end
  exit(0)
elsif args[:clean_cache]
  clean_opts = {}
  clean_opts[:cache_dir] = args[:cache_dir] if args[:cache_dir]
  Kompo.clean_cache(args[:clean_cache], **clean_opts)
elsif args[:no_clean]
  Kompo::Packing.run(args:)
else
  Kompo::Packing.run_and_clean(args:)
end
